name: Deploy Scraper to Cloud Run Job

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # 讓你可以手動按按鈕觸發

env:
  PROJECT_ID: project-tjr104-cafe # 你的 GCP 專案 ID
  REGION: asia-east1             # 台灣區域
  SERVICE_NAME: cafe-scraper     # 你的 Job 名稱
  REPO_NAME: cafe-apps           # Artifact Registry 的倉庫名稱

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 透過 Service Account Key 登入 GCP
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. 設定 gcloud 指令與 Docker 認證
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker for Artifact Registry'
        run: |
          gcloud auth configure-docker asia-east1-docker.pkg.dev --quiet

      # 3. 建立並推送 Docker 映像檔
      - name: Build and Push Container
        run: |
          DOCKER_TAG="asia-east1-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          docker build -t $DOCKER_TAG .
          docker push $DOCKER_TAG

      # 4. 部署為 Cloud Run Job (關鍵修正：使用 jobs deploy)
      - name: Deploy to Cloud Run Job
        run: |
          # 刪除之前誤建的 Service 避免名稱衝突 (失敗也沒關係，所以加 || true)
          gcloud run services delete ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --quiet || true

          # 建立或更新 Cloud Run Job
          gcloud run jobs deploy ${{ env.SERVICE_NAME }} \
            --image asia-east1-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --max-retries 0 \
            --task-timeout 600s

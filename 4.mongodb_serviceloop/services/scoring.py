# app/services/scoring.py
import math

def calculate_comprehensive_score(
    vec_score: float,             # 1. å‘é‡ç›¸ä¼¼åº¦ (0.0 ~ 1.0)
    rating: float,                # 2. åŸå§‹æ˜Ÿç´š (0.0 ~ 5.0)
    total_reviews: int,           # 3. ç¸½è©•è«–æ•¸
    dist_meters: float,           # 4. çµ•å°è·é›¢ (å…¬å°º)
    dist_to_nearest_mrt: float,   # 5. è·é›¢æœ€è¿‘æ·é‹ç«™ (å…¬å°º)
    hours_until_close: float,     # 6. è·é›¢æ‰“çƒŠæ™‚é–“ (å°æ™‚ï¼Œè² æ•¸ä»£è¡¨å·²æ‰“çƒŠ)
    clicks: int = 0,              # 7. è¡Œç‚ºæŒ‡æ¨™ï¼šé»æ“ŠæŸ¥çœ‹åœ°åœ–æ¬¡æ•¸
    keeps: int = 0,               # 8. è¡Œç‚ºæŒ‡æ¨™ï¼šåŠ å…¥æ”¶è—æ¬¡æ•¸
    dislikes: int = 0,            # ğŸŒŸ æ–°å¢ 9. è¡Œç‚ºæŒ‡æ¨™ï¼šé»æ“Šä¸å–œæ­¡(ä¸è¡Œ)æ¬¡æ•¸
    last_recommended_hours: float = float('inf'), # è·é›¢ä¸Šæ¬¡æ¨è–¦éå¹¾å°æ™‚
    is_new_user: bool = False,    # æ˜¯å¦ç‚ºæ–°ä½¿ç”¨è€… (ç”¨æ–¼æ§åˆ¶å›é¥‹æ¯”ç‡)
    global_avg_rating: float = 4.2, # å…¨å±€å¹³å‡æ˜Ÿç´š (å¯ä¾æ“š DB ç‹€æ…‹èª¿æ•´)
    has_disliked_features: bool = False # ğŸŒŸ æ–°å¢ 10. æ˜¯å¦å¸¶æœ‰ä½¿ç”¨è€…å‰›å‰›æ‹’çµ•çš„ç‰¹å¾µ (åŠ‡æœ¬äºŒ)
) -> float:
    """
    è¨ˆç®—å’–å•¡å»³æ¨è–¦æœ€çµ‚åŠ æ¬Šåˆ†æ•¸ (The 8-Dimension Scoring Formula V2)
    æ”¯æ´æ­£è² å‘è¡Œç‚ºæ‰£åˆ†èˆ‡éš±æ€§ç‰¹å¾µæ‡²ç½°
    """

    # ---------------------------------------------------------
    # ç¶­åº¦ 1~3: ç¶œåˆå“è³ªæŒ‡æ¨™ (Quality)
    # ---------------------------------------------------------
    # A. è²æ°å¹³å‡éœæ…‹åˆ†æ•¸ (Bayesian Average)
    m = 50.0  # ä¿¡å¿ƒé–€æª»å€¼
    bayesian_rating = ((total_reviews / (total_reviews + m)) * rating + 
                       (m / (total_reviews + m)) * global_avg_rating)
    s_static = bayesian_rating / 5.0 

    # B. ç‡Ÿæ¥­æ™‚é–“å……è£•åº¦åˆ†æ•¸
    if hours_until_close >= 3:
        s_time = 1.0
    elif hours_until_close > 0:
        s_time = hours_until_close / 3.0  # å‰©é¤˜æ™‚é–“æ¯”ä¾‹
    else:
        s_time = 0.0  # å·²æ‰“çƒŠæˆ–å³å°‡æ‰“çƒŠ
        
    # æ•´åˆå“è³ªåˆ†æ•¸ (70% çœ‹è©•åƒ¹ï¼Œ30% çœ‹ç‡Ÿæ¥­æ™‚é–“é¤˜è£•)
    score_quality = (s_static * 0.7) + (s_time * 0.3)

    # ---------------------------------------------------------
    # ç¶­åº¦ 4~5: ç¶œåˆåœ°ç†æŒ‡æ¨™ (Location)
    # ---------------------------------------------------------
    # A. çµ•å°è·é›¢è¡°æ¸› (1500m ç‚ºåŸºæº–)
    s_geo_abs = math.exp(-dist_meters / 1500.0)
    
    # B. æ·é‹äº¤é€šä¾¿åˆ©æ€§è¡°æ¸› (500m ç‚ºåŸºæº–ï¼Œç²¾è¯å€)
    s_geo_mrt = math.exp(-dist_to_nearest_mrt / 500.0)
    
    # æ•´åˆåœ°ç†åˆ†æ•¸ (60% çœ‹å¯¦éš›è·é›¢ï¼Œ40% çœ‹æ·é‹ä¾¿åˆ©æ€§)
    score_location = (s_geo_abs * 0.6) + (s_geo_mrt * 0.4)

    # ---------------------------------------------------------
    # ğŸŒŸ ç¶­åº¦ 6~8: è¡Œç‚ºæŒ‡æ¨™ (Behavior) - é›™å‘å¹³æ»‘å‡ç´šç‰ˆ
    # ---------------------------------------------------------
    # è¨ˆç®—äº’å‹•æ·¨å€¼ (Score_act)
    score_act = (keeps * 3.0) + (clicks * 1.0) - (dislikes * 2.0)
    
    # é›™å‘æ­£è¦åŒ–å…¬å¼ (Bi-directional Normalization)
    if score_act == 0:
        s_behavior = 0.0
    else:
        # å–ç¬¦è™Ÿ (1.0 æˆ–æ˜¯ -1.0)
        sign = 1.0 if score_act > 0 else -1.0
        # å¥—ç”¨å¹³æ»‘è¡°æ¸›å…¬å¼ (ç¢ºä¿åˆ†æ•¸ç•Œæ–¼ -1.0 ~ 1.0 ä¹‹é–“)
        s_behavior = sign * (1.0 - math.exp(-abs(score_act) / 10.0))

    # ---------------------------------------------------------
    # ç¶­åº¦ 9: å†·å•Ÿå‹•é˜²è­· (Cold Start)
    # ---------------------------------------------------------
    p_cold = 0.05 if total_reviews < 10 else 0.0

    # ---------------------------------------------------------
    # å‹•æ…‹æ¬Šé‡åˆ†é… (Weight Distribution)
    # ---------------------------------------------------------
    if is_new_user:
        # æ–°ä½¿ç”¨è€…ï¼šä¾è³´ AI èªæ„èˆ‡å®¢è§€è©•åƒ¹ï¼Œä¸æ¡è¨ˆè¡Œç‚ºå½±éŸ¿
        w_vec, w_qual, w_loc, w_beh = 0.40, 0.40, 0.20, 0.00
    else:
        # è€ä½¿ç”¨è€…ï¼šåŠ å…¥è¡Œç‚ºåå¥½æ¬Šé‡
        w_vec, w_qual, w_loc, w_beh = 0.35, 0.30, 0.15, 0.20

    # è¨ˆç®—åˆæ­¥ç¸½åˆ†
    base_score = (w_vec * vec_score) + \
                 (w_qual * score_quality) + \
                 (w_loc * score_location) + \
                 (w_beh * s_behavior) + \
                 p_cold

    # ---------------------------------------------------------
    # ğŸŒŸ éš±æ€§ç‰¹å¾µæ‡²ç½° (Implicit Feature Penalty - åŠ‡æœ¬äºŒ)
    # ---------------------------------------------------------
    # å¦‚æœé€™å®¶åº—å¸¶æœ‰ä½¿ç”¨è€…å‰›å‰›ã€Œä¸çµ¦åŸå› æ‹’çµ•ã€çš„åº—å®¶ç‰¹å¾µï¼Œåˆæ­¥ç¸½åˆ†æ‰“ 8 æŠ˜
    if has_disliked_features:
        base_score *= 0.8

    # ---------------------------------------------------------
    # æ¨è–¦å†·å»æœŸæ‡²ç½° (Cooldown Penalty)
    # ---------------------------------------------------------
    penalty = 1.0
    if last_recommended_hours < 24:
        penalty = 0.1  # 24H å…§æ¨éï¼Œæ‰“ 1 æŠ˜æ²‰åº•
    elif last_recommended_hours < 48:
        penalty = 0.5  # 24~48H å…§æ¨éï¼Œæ‰“ 5 æŠ˜

    final_score = base_score * penalty

    # ç¢ºä¿æœ€çµ‚åˆ†æ•¸è½åœ¨ 0.0 ~ 1.0 ä¹‹é–“
    return max(0.0, min(1.0, final_score))